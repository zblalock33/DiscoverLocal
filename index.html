<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Discover Local</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    .app-title {
      position: fixed;
      z-index: 10;
      top: 0;
      left: 0;
      width: 100%;
      color: #FFFFFF;
      background-color: #8B0000;
      padding: 8px 0;
      font-size: 18px;
      text-align: center;
      box-sizing: border-box;
    }

    .action-select {
      position: fixed;
      z-index: 10;
      top: 10px;
      right: 10px;
      background-color: #8B0000;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      box-sizing: border-box;
    }

    .action-select:hover {
      background-color: #640000;
    }

    #searchWidgetDiv {
      display: none;
      position: fixed;
      z-index: 10;
      top: 60px;
      left: 0;
      right: 0;
      padding: 0 10px;
      box-sizing: border-box;
    }

    .embed-container {
      position: relative;
      padding-bottom: 80%;
      height: 0;
      max-width: 100%;
    }

    .embed-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

  </style>
</head>
<body>
    <header class="app-title">DiscoverLocal</header>
    <select class="action-select" id="actionSelect">
      <option value="">Options</option>
      <option value="addRecord">Add Venue</option>
      <option value="toggleSearch">Search</option>
    </select>
    <div id="searchWidgetDiv"></div>
    <input type="text" id="venueNameInput" placeholder="Venue Name" />
    <select id="venueTypeInput">
      <option value="">Select Venue Type</option>
      <option value="Bar">Bar</option>
      <option value="Restaurant">Restaurant</option>
      <option value="Arcade">Arcade</option>
      <option value="Other">Other</option>
    </select>
    <button id="searchButton">Search</button>
    <div id="viewDiv"></div>
    <div class="embed-container" id="surveyContainer" style="display:none;">
    <iframe name="survey123webform" width="500" height="400" frameborder="0" marginheight="0" marginwidth="0" title="DiscoverLocal" src="https://survey123.arcgis.com/share/16f8e266ef6b421fb8c2537c5941b2f9" allow="geolocation https://survey123.arcgis.com; camera https://survey123.arcgis.com"></iframe>
  </div>
  <script src="https://js.arcgis.com/4.29/"> </script>
  <script>
    require([
      "esri/config", 
      "esri/Map", 
      "esri/views/MapView", 
      "esri/widgets/Locate", 
      "esri/widgets/Search",
      "esri/layers/FeatureLayer",
    ], function(esriConfig, Map, MapView, Locate, Search, FeatureLayer, Graphic, SimpleMarkerSymbol, SimpleRenderer) {


        esriConfig.apiKey = "AAPK612e73527e6c46738fb31fd7d030b6b1WYykMd_XA3IY3DfR4HA2lXy14UdWbOijIJYcfPMb9CqP7B_gvsbt_yy67N61TfuU";

        const map = new Map({
              basemap: "satellite"
        });

        const view = new MapView({
              container: "viewDiv",
              map: map,
              center: [-98.5795, 39.8283],
              zoom: 3,
              ui: {
                components: ["attribution"]
              }
        });

        const locateBtn= new Locate({
            view : view
        });

  // Define the popup template with a link to the survey
  const popupTemplate = {
          title: "{venue_name}",
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "venue_name",
                  label: "Venue Name"
                },
                {
                  fieldName: "venue_type",
                  label: "Venue Type"
                },
                {
                  fieldName: "untitled_question_9_other",
                  label: "Other Venue Type"
                },
                {
                  fieldName: "add_venue_location",
                  label: "Venue Location"
                }
                // ... [add other fields as needed] ...
              ]
            },
            {
              type: "text",
              text: "<a href='https://arcg.is/1XnO550' target='_blank'>Leave a Review and Rating!</a>"
            }
          ]
        };

        // Apply the popup template to the feature layer
        const layer = new FeatureLayer({
          url: "https://services.arcgis.com/LBbVDC0hKPAnLRpO/arcgis/rest/services/survey123_16f8e266ef6b421fb8c2537c5941b2f9_results/FeatureServer",
          outFields: ["*"],
          popupTemplate: popupTemplate
        });

        map.add(layer);

        view.ui.add (locateBtn, {
            position: "top-left"
        });

   // Configure the Search widget to use the feature layer as its source
   const searchWidget = new Search({
            view: view,
            sources: [
              {
                layer: layer,
                searchFields: ["venue_name", "venue_type",], // Specify the fields to search in
                displayField: "venue_name", // Specify the field name to display in the search results
                exactMatch: false,
                outFields: ["*"],
                name: "Local Venues",
                placeholder: "Search for a venue",
                popupTemplate: popupTemplate // Use the custom popup template
              }
            ],
            popupEnabled: true,
            popupOpenOnSelect: true,
            resultGraphicEnabled: true,
            autoSelect: true
        });

           // Attach the search widget to its container
        searchWidget.container = document.getElementById("searchWidgetDiv");

        document.getElementById('actionSelect').addEventListener('change', function() {
            var action = this.value;
            if (action === 'toggleSearch') {
                var searchWidgetDiv = document.getElementById('searchWidgetDiv');
                searchWidgetDiv.style.display = searchWidgetDiv.style.display === 'none' ? 'block' : 'none';
            } else if (action === 'addRecord') {
                var surveyContainer = document.getElementById('surveyContainer');
                surveyContainer.style.display = surveyContainer.style.display === 'none' ? 'block' : 'none';
            }
        });

        document.getElementById('searchButton').addEventListener('click', function() {
          var venueName = document.getElementById('venueNameInput').value.trim();
          var venueType = document.getElementById('venueTypeInput').value.trim();
          performSearch(venueName, venueType);
        });

        function performSearch(venueName, venueType) {
          var query = layer.createQuery();
          var whereClause = [];

          if (venueName) {
            whereClause.push("venue_name LIKE '%" + venueName + "%'");
          }
          if (venueType) {
            whereClause.push("venue_type = '" + venueType + "'");
          }

          query.where = whereClause.join(' AND ');
          query.returnGeometry = true;
          query.outFields = ["*"];

          layer.queryFeatures(query).then(function(results) {
            console.log(results);
            // Process and display the results as needed
          }).catch(function(error) {
            console.error("Search failed: ", error);
          });
        }
    });
  </script>
</body>
</html>